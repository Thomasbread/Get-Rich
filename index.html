<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Stadtplan – Deluxe Games & Investments (Get Rich 4.0 - Final)</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #222;
  color: #f1f1f1;
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  position: relative;
  font-size: 3vmin; /* Relative Schriftgröße */
}

header {
  background: #333;
  padding: 2vmin;
  text-align: center;
  font-size: 3vmin;
  flex-shrink: 0;
  position: relative;
}
    header span { font-weight: bold; }
    #total-credit { color: #ff0; }
    #countdown {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 0.9rem;
      color: #fff;
    }
    #expense-countdown {
  position: absolute;
  top: 30px; /* Unterhalb des #countdown */
  right: 10px;
  font-size: 0.9rem;
  color: #ff0; /* Gelb für bessere Sichtbarkeit */
}
    #main-container {
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      flex: 1;
      overflow: auto;
      width: 100vw; /* Vollständige Breite des Bildschirms */
      height: 100vh; /* Vollständige Höhe des Bildschirms */
      padding: 10px; /* Etwas Platz an den Rändern */
      box-sizing: border-box;
    }
    .panel {
  display: none;
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.95);
  padding: 5vmin; /* Relative Polsterung */
  overflow-y: auto;
  box-sizing: border-box;
}
.back-button, .shop-button, .bank-button, .credit-button, .invoice-button, .house-button {
  margin: 2vmin;
  padding: 2vmin 4vmin;
  background: #007acc;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  transition: background 0.3s;
  font-size: 3vmin; /* Größere Schrift für Touch */
  touch-action: manipulation; /* Verhindert Zoom bei Touch */
}
    .back-button:hover, .shop-button:hover, .bank-button:hover, .credit-button:hover, .invoice-button:hover, .house-button:hover {
      background: #005f99;
    }
    .building-icon {
  position: absolute;
  width: 22vmin; /* Von 20vmin auf 22vmin erhöht */
  height: 22vmin; /* Von 20vmin auf 22vmin erhöht */
  cursor: pointer;
  transition: transform 0.3s;
  z-index: 5;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 9vmin; /* Von 8vmin auf 9vmin erhöht */
  text-shadow: 1px 1px 2px #000;
}
    .building-icon.active {
  transform: scale(1.1); /* Simuliert Hover-Effekt */
}
#city-map {
  position: relative;
  width: 100%; /* Relative Breite */
  max-width: 800px; /* Maximale Breite für größere Bildschirme */
  height: auto; /* Höhe anpassen */
  aspect-ratio: 4 / 3; /* Verhältnis 4:3 beibehalten */
  background: none;
  z-index: 1;
  transform: translateY(-5mm); /* Schiebt den Stadtplan 5 mm nach oben */
}
    #city-map svg {
      width: 100%;
      height: 100%;
      z-index: 1;
    }
    #house-icon { top: 30px; left: 30px; }
    #bank-icon { top: 30px; left: 570px; }
    #casino-icon { top: 250px; left: 310px; }
    #supermarket-icon { top: 440px; left: 30px; }
    #shop-icon { top: 440px; left: 570px; }
    #cars-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 20;
    }
    .car {
      position: absolute;
      font-size: 24px;
      cursor: pointer;
      pointer-events: auto;
      z-index: 20;
    }
    #house-panel { background: #2d2d2d; position: relative; text-align: center; }
    .house-interior {
  width: 100%; /* Volle Breite auf kleinen Bildschirmen */
  max-width: 600px; /* Maximale Breite für größere Bildschirme */
  height: 50vmin; /* Relative Höhe */
  margin: 2vmin auto;
  background: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='600' height='400'><rect width='600' height='400' fill='#2d2d2d'/><line x1='0' y1='200' x2='600' y2='200' stroke='#fff' stroke-width='3' stroke-dasharray='10,10'/></svg>") center/cover no-repeat;
  border: 2px solid #444;
  border-radius: 10px;
}

/* Für Bildschirme kleiner als 600px */
@media (max-width: 600px) {
  #city-map {
    aspect-ratio: 1 / 1; /* Quadratisches Layout auf kleinen Bildschirmen */
  }

  .building-icon {
    width: 16.5vmin; /* Von 15vmin auf 16.5vmin erhöht */
    height: 16.5vmin;
    font-size: 6.5vmin; /* Von 6vmin auf 6.5vmin erhöht */
  }

  #memecoin-kurse, #countdowns {
    width: 40vmin;
    font-size: 2.5vmin;
  }

  .house-interior {
    height: 40vmin;
  }

  #game-board {
    width: 100%;
    max-width: 400px;
  }

  .cell {
    min-width: 0; /* Verhindert Überlauf */
  }
}
    #mailbox {
      position: absolute;
      bottom: 20px;
      left: 20px;
      width: 80px;
      height: 80px;
      cursor: pointer;
      background: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 100 100'><rect x='20' y='30' width='60' height='40' fill='#f66' stroke='#000' stroke-width='2'/><text x='50' y='55' font-size='10' fill='#000' text-anchor='middle'>Brief</text></svg>") center/contain no-repeat;
    }
    #casino-panel { background: #1a1a1a; }
    #casino-panel .tab-buttons button {
      padding: 10px 20px;
      background: linear-gradient(145deg, #007acc, #005f99);
      border: none;
      border-radius: 5px;
      cursor: pointer;
      color: #fff;
      font-size: 1rem;
      transition: box-shadow 0.3s;
    }
    #casino-panel .tab-buttons .active {
      background: #00b300;
      box-shadow: 0 0 10px #00ff00;
    }
    #game-board {
  display: grid;
  gap: 2px;
  margin: 2vmin auto;
  width: 90%;
  max-width: 500px;
  transform-style: preserve-3d;
  transition: transform 0.5s;
}
    .cell {
      width: 100%;
      aspect-ratio: 1;
      background: linear-gradient(145deg, #3e3e3e, #2a2a2a);
      border: 1px solid #1a1a1a;
      border-radius: 5px;
      cursor: pointer;
      position: relative;
      transition: transform 0.3s, background 0.3s;
      transform-style: preserve-3d;
      box-shadow: 2px 2px 4px rgba(0,0,0,0.6), -2px -2px 4px rgba(255,255,255,0.1);
    }
    .cell:hover {
      transform: translateY(-3px) rotateX(5deg);
      background: linear-gradient(145deg, #4a4a4a, #333333);
    }
    .cell.revealed {
      background: linear-gradient(145deg, #b0b0b0, #999);
      cursor: default;
      transform: none;
    }
    .cell.mine { background: radial-gradient(circle, #ff0000, #8b0000); }
    #plinko-canvas, #roulette-canvas {
  display: block;
  margin: 2vmin auto;
  width: 100%; /* Volle Breite auf kleinen Bildschirmen */
  max-width: 500px;
  height: auto;
  aspect-ratio: 5 / 4; /* Verhältnis beibehalten */
  background: #222;
  border: 2px solid #555;
  border-radius: 10px;
}
    #slots-game {
  background: #333; /* Dunkler Hintergrund */
  border: 5px solid #444; /* Rahmen wie bei einer Maschine */
  border-radius: 10px; /* Abgerundete Ecken */
  box-shadow: 0 0 10px rgba(0,0,0,0.5); /* Schatten für 3D-Effekt */
}
    #shop-panel {
      background: #1e1e1e;
      text-align: center;
    }
    .shop-section { margin: 15px 0; }
    #bank-panel {
      background: #2b2b2b;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      border-radius: 10px;
      display: flex;
      justify-content: space-between;
    }
    .bank-section {
      margin-bottom: 20px;
      padding: 10px;
      background: #3a3a3a;
      border-radius: 8px;
    }
    .bank-section h3 { margin-bottom: 10px; }
    label, input {
      text-align: center;
      margin: 5px auto;
      display: block;
    }
    input {
      padding: 5px;
      width: 200px;
    }
    #invoice-bar, #credit-bar {
      background: #770000;
      border-radius: 5px;
      padding: 10px;
      color: #fff;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #credit-take-buttons {
      margin-bottom: 10px;
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    #supermarket-panel {
      background: #444;
      text-align: center;
      padding-top: 20px;
    }
    #supermarket-panel p { margin: 10px 0; }
    #investment-section p:last-child {
      margin-top: 10px;
      font-size: 0.9rem;
    }
    #building-emoji {
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 32px;
    }
    #memecoin-kurse {
      position: absolute;
      top: 50px;
      left: 10px;
      width: 200px;
      background: #333;
      padding: 10px;
      border-radius: 5px;
      color: #fff;
    }
    .arrow-up {
      color: green;
    }
    .arrow-down {
      color: red;
    }
    .draggable {
  transition: transform 0.2s;
}

.draggable.dragging {
  opacity: 0.5;
  transform: scale(1.2);
}

.dropzone {
  transition: background 0.3s;
}

.dropzone.dragover {
  background: #b2dfdb !important; /* Hellere Farbe beim Überfahren */
  border: 2px solid #0288d1;
}
    .reel {
  width: 100px;
  height: 100px;
  display: flex;
  justify-content: center;
  align-items: center;
  background: #fff;
  border: 2px solid #000;
  border-radius: 10px;
  font-size: 64px;
}
  </style>
  <script src="https://sdk.crazygames.com/crazygames-sdk-v3.js"></script>
</head>
<body>
  <header>
    Balance: €<span id="balance-display">100.00</span> | 
    Bank: €<span id="bank-display">0.00</span> | 
    Gesamtkredit: €<span id="total-credit">0.00</span> | 
    Aktien: €<span id="stocks-display">0.00</span> | 
    Investmentfond: €<span id="investment-display">0.00</span> | 
    Memecoins: €<span id="memecoin-display">0.00</span>
    <div id="countdown">60s</div>
    <div id="expense-countdown">Nächste Alltagskosten: 5:00</div>
  </header>
  <div id="memecoin-kurse"></div>
  <div id="countdowns" style="position: absolute; top: 250px; left: 10px; width: 200px; background: #333; padding: 10px; border-radius: 5px; color: #fff;">
    <h3>Countdowns</h3>
    <p>Kurswechsel: <span id="countdown">60s</span></p>
    <p>Steuer: <span id="tax-countdown">25:00</span></p>
  </div>
  <div id="main-container">
    <div id="goals" style="position: absolute; top: 50px; right: 10px; width: 200px; background: #333; padding: 10px; border-radius: 5px; color: #fff;">
      <h3>Langzeitziele</h3>
      <ul id="goal-list"></ul>
  </div>
    <div id="city-map" class="panel">
      <h2 style="text-align:center; position: relative; z-index: 3;">Stadtplan</h2>
      <svg width="800" height="600" style="position: relative; z-index: 1;">
        <defs>
          <linearGradient id="casinoGradient" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" style="stop-color:#FF69B4;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#8A2BE2;stop-opacity:1" />
          </linearGradient>
          <filter id="shadow">
            <feDropShadow dx="3" dy="3" stdDeviation="3" flood-opacity="0.3" />
          </filter>
        </defs>
        <rect width="800" height="600" fill="#a8dadc"/>
        <g class="roads">
          <rect x="0" y="200" width="800" height="20" fill="#707070" stroke="#505050" stroke-width="2"/>
          <line x1="0" y1="210" x2="800" y2="210" stroke="white" stroke-width="3" stroke-dasharray="10,10"/>
          <rect x="0" y="400" width="800" height="20" fill="#707070" stroke="#505050" stroke-width="2"/>
          <line x1="0" y1="410" x2="800" y2="410" stroke="white" stroke-width="3" stroke-dasharray="10,10"/>
          <rect x="260" y="0" width="20" height="600" fill="#707070" stroke="#505050" stroke-width="2"/>
          <line x1="270" y1="0" x2="270" y2="600" stroke="white" stroke-width="3" stroke-dasharray="10,10"/>
          <rect x="520" y="0" width="20" height="600" fill="#707070" stroke="#505050" stroke-width="2"/>
          <line x1="530" y1="0" x2="530" y2="600" stroke="white" stroke-width="3" stroke-dasharray="10,10"/>
        </g>
        <g id="trees">
          <g class="tree">
            <circle cx="305" cy="140" r="20" fill="#2e8b57"/>
            <circle cx="300" cy="150" r="18" fill="#3cb371"/>
            <rect x="300" y="160" width="10" height="20" fill="#8B4513"/>
          </g>
          <g class="tree">
            <circle cx="505" cy="40" r="20" fill="#2e8b57"/>
            <circle cx="500" cy="50" r="18" fill="#3cb371"/>
            <rect x="500" y="60" width="10" height="20" fill="#8B4513"/>
          </g>
        </g>
        <rect x="280" y="20" width="80" height="60" fill="#d2b48c" stroke="#8b4513" stroke-width="2" rx="5" ry="5"/>
        <rect x="420" y="100" width="70" height="50" fill="#d2b48c" stroke="#8b4513" stroke-width="2" rx="5" ry="5"/>
        <rect x="30" y="230" width="80" height="60" fill="#d2b48c" stroke="#8b4513" stroke-width="2" rx="5" ry="5"/>
        <rect x="150" y="310" width="80" height="60" fill="#d2b48c" stroke="#8b4513" stroke-width="2" rx="5" ry="5"/>
        <rect x="540" y="230" width="80" height="60" fill="#d2b48c" stroke="#8b4513" stroke-width="2" rx="5" ry="5"/>
        <rect x="660" y="310" width="80" height="60" fill="#d2b48c" stroke="#8b4513" stroke-width="2" rx="5" ry="5"/>
        <rect x="280" y="430" width="80" height="60" fill="#d2b48c" stroke="#8b4513" stroke-width="2" rx="5" ry="5"/>
        <rect x="420" y="500" width="80" height="60" fill="#d2b48c" stroke="#8b4513" stroke-width="2" rx="5" ry="5"/>
      </svg>
      <div id="house-icon" class="building-icon" title="Haus">🏠</div>
      <div id="bank-icon" class="building-icon" title="Bank">🏦</div>
      <div id="casino-icon" class="building-icon" title="Casino">🎰</div>
      <div id="supermarket-icon" class="building-icon" title="Supermarkt">🛒</div>
      <div id="shop-icon" class="building-icon" title="Shop">🛍️</div>
      <div id="cars-container"></div>
    </div>

    <div id="house-panel" class="panel">
      <div id="building-emoji"></div>
      <h2>Dein Haus</h2>
      <p>Willkommen in deinem Heim.</p>
      <div class="house-interior"></div>
      <div id="mailbox" title="Klicke, um den Bankbrief zu lesen"></div>
      <button class="back-button" onclick="showPanel('city-map')">Zurück zur Stadt</button>
    </div>

    <div id="bank-panel" class="panel">
      <div id="building-emoji"></div>
      <div style="display: flex; justify-content: space-between;">
        <div style="width: 48%;">
          <div id="invoice-bar">Gesamt-Rechnungen: €<span id="total-invoices">0.00</span> <button class="bank-button" onclick="payAllInvoices()">Alle bezahlen</button></div>
          <div id="credit-take-buttons">
            <button class="credit-button" onclick="takeCredit(1000)">Kredit 1.000€</button>
            <button class="credit-button" onclick="takeCredit(5000)">Kredit 5.000€</button>
            <button class="credit-button" onclick="takeCredit(10000)">Kredit 10.000€</button>
          </div>
          <div id="credit-bar">Gesamt-Kredite: €<span id="total-credits">0.00</span> <button class="bank-button" onclick="payAllCredits()">Alle abzahlen</button></div>
          <div id="house-section">
            <h3>Hausverwaltung</h3>
            <button class="house-button" onclick="sellHouse()">Haus verkaufen (500.000€)</button>
            <button class="house-button" onclick="buyHouse()">Haus zurückkaufen (500.000€)</button>
            <p id="house-status"></p>
          </div>
          <div class="bank-section">
            <h3>Ein-/Auszahlen</h3>
            <label for="bank-deposit">Einzahlen (€):</label>
            <input type="number" id="bank-deposit" value="0" min="0">
            <button id="deposit-btn" class="bank-button">Einzahlen</button>
            <label for="bank-withdraw">Abheben (€):</label>
            <input type="number" id="bank-withdraw" value="0" min="0">
            <button id="withdraw-btn" class="bank-button">Abheben</button>
            <p>Bankguthaben: €<span id="bank-balance">0.00</span></p>
          </div>
        </div>
        <div style="width: 48%;">
          <div class="bank-section" id="investment-section">
            <h3>Investmentfond</h3>
            <label for="invest-amount">Investmentfond (€):</label>
            <input type="number" id="invest-amount" value="0" min="0">
            <button id="invest-btn" class="bank-button">Investieren</button>
            <button id="withdraw-investment-btn" class="bank-button">Auszahlen</button>
            <p>Fondwert: €<span id="investment-value">0.00</span></p>
          </div>
          <div class="bank-section" id="stocks-section">
            <h3>Aktien</h3>
            <label for="stocks-invest-amount">Aktien (€):</label>
            <input type="number" id="stocks-invest-amount" value="0" min="0">
            <button id="stocks-invest-btn" class="bank-button">Investieren</button>
            <button id="withdraw-stocks-btn" class="bank-button">Auszahlen</button>
            <p>Aktienwert: €<span id="stocks-value">0.00</span></p>
          </div>
          <div class="bank-section" id="memecoin-section" style="display:none;">
            <h3>Memecoins</h3>
            <div id="memecoin-container"></div>
          </div>
        </div>
      </div>
      <button class="back-button" onclick="showPanel('city-map')">Zurück zur Stadt</button>
    </div>

    <div id="casino-panel" class="panel">
      <div id="building-emoji"></div>
      <h2>Casinobereich</h2>
      <div class="tab-buttons" style="text-align:center; margin-bottom:15px;">
        <button id="casino-mines-tab" class="bank-button active" onclick="showCasinoTab('mines-game')">Mines</button>
        <button id="casino-plinko-tab" class="bank-button" onclick="showCasinoTab('plinko-game')">Plinko</button>
        <button id="casino-roulette-tab" class="bank-button" onclick="showCasinoTab('roulette-game')">Roulette</button>
        <button id="casino-slots-tab" class="bank-button" onclick="showCasinoTab('slots-game')">Slots</button>
      </div>
      <div class="casino-content">
        <div id="mines-game" style="display:block;">
          <div class="controls" style="text-align:center; margin-bottom:10px;">
            <label for="grid-size">Grid Größe:</label>
            <select id="grid-size">
              <option value="5">5x5</option>
              <option value="7">7x7</option>
              <option value="10">10x10</option>
              <option value="12">12x12</option>
            </select>
            <label for="mines-count">Minen Anzahl:</label>
            <input type="number" id="mines-count" value="10" min="1" style="width:60px;">
            <label for="mines-bet">Einsatz (€):</label>
            <input type="number" id="mines-bet" value="10" min="1" style="width:60px;">
            <button id="start-game" class="bank-button">Spiel Starten</button>
          </div>
          <div id="game-board"></div>
          <div class="scoreboard" style="text-align:center; margin-top:10px;">
            <p>Gewinnmultiplikator: <span id="multiplier">1.00</span>x</p>
            <p id="game-message"></p>
          </div>
          <button id="take-profit" class="bank-button" style="display:block; margin:10px auto;">Take Profit</button>
        </div>
        <div id="plinko-game" style="display:none;">
          <div class="controls" style="text-align:center; margin-bottom:10px;">
            <label for="plinko-bet">Einsatz (€):</label>
            <input type="number" id="plinko-bet" value="10" min="1" style="width:60px;">
            <button id="play-plinko" class="bank-button">Plinko Spielen</button>
          </div>
          <canvas id="plinko-canvas" width="500" height="400"></canvas>
          <p id="plinko-message" style="text-align:center; margin-top:10px;"></p>
        </div>
        <div id="roulette-game" style="display:none;">
          <div class="controls" style="text-align:center; margin-bottom:10px;">
            <label for="roulette-bet">Einsatz (€):</label>
            <input type="number" id="roulette-bet" value="10" min="1" style="width:60px;">
            <label for="roulette-wette">Wette auf:</label>
            <select id="roulette-wette">
              <option value="zahl">Zahl (0-36)</option>
              <option value="farbe">Farbe (Rot/Schwarz)</option>
            </select>
            <input type="text" id="roulette-wette-input" placeholder="Zahl oder Farbe" style="width:100px;">
            <button id="play-roulette" class="bank-button">Roulette Spielen</button>
          </div>
          <canvas id="roulette-canvas" width="500" height="400"></canvas>
          <p id="roulette-message" style="text-align:center; margin-top:10px;"></p>
        </div>
        <div id="slots-game" style="display:none; position:relative; width:100%; height:100%;">
          <div style="position:relative; z-index:2; padding:20px;">
            <div class="controls" style="text-align:center; margin-bottom:10px;">
              <label for="slots-bet">Einsatz (€):</label>
              <input type="number" id="slots-bet" value="10" min="1" style="width:60px;">
              <button id="play-slots" class="bank-button">Spin</button>
            </div>
            <div id="slots-reels" style="display:flex; justify-content:center; margin-top:20px;">
              <div class="reel" style="font-size:64px; margin:0 10px;">🍒</div>
              <div class="reel" style="font-size:64px; margin:0 10px;">🍋</div>
              <div class="reel" style="font-size:64px; margin:0 10px;">🍊</div>
            </div>
            <p id="slots-message" style="text-align:center; margin-top:10px;"></p>
          </div>
        </div>
      </div>
      <button class="back-button" onclick="showPanel('city-map')">Zurück zur Stadt</button>
    </div>

    <div id="supermarket-panel" class="panel">
      <div id="building-emoji"></div>
      <h2>Supermarkt</h2>
      <p>Arbeite hier und verdiene 30€! Ziehe 10 Lebensmittel per Drag-and-Drop in die richtigen Regale.</p>
      <p>Fortschritt: <span id="progress-counter">0</span>/10</p>
      <div id="work-area" style="display: flex; justify-content: space-between; align-items: center; height: 300px; margin: 20px 0;">
        <!-- Lebensmittel zum Ziehen -->
        <div id="food-items" style="width: 30%; text-align: center; color: #000;">
          <h3>Lebensmittel</h3>
          <div id="draggable-food" class="draggable" draggable="true" style="font-size: 48px; margin: 10px; cursor: move;"></div>
        </div>
        <!-- Regale als Drop-Zonen -->
        <div id="shelves" style="width: 60%; display: flex; flex-direction: column; gap: 10px;">
          <div id="shelf-milk" class="dropzone" data-category="milch" style="height: 60px; background: #e0f7fa; border: 2px dashed #0288d1; border-radius: 5px; text-align: center; line-height: 60px; color: #000;">🥛 Milchprodukte</div>
          <div id="shelf-fruit" class="dropzone" data-category="obst" style="height: 60px; background: #f1f8e9; border: 2px dashed #7cb342; border-radius: 5px; text-align: center; line-height: 60px; color: #000;">🍎 Obst & Gemüse</div>
          <div id="shelf-meat" class="dropzone" data-category="fleisch" style="height: 60px; background: #ffebee; border: 2px dashed #d32f2f; border-radius: 5px; text-align: center; line-height: 60px; color: #000;">🍗 Fleisch</div>
          <div id="shelf-snacks" class="dropzone" data-category="snacks" style="height: 60px; background: #fff3e0; border: 2px dashed #f57c00; border-radius: 5px; text-align: center; line-height: 60px; color: #000;">🍟 Snacks</div>
        </div>
      </div>
      <p id="work-message" style="text-align: center;"></p>
      <button class="bank-button" id="work-button">Nächste Aufgabe</button>
      <button class="back-button" onclick="showPanel('city-map')">Zurück zur Stadt</button>
    </div>

    <div id="shop-panel" class="panel">
        <div id="building-emoji"></div>
        <h2>Stadt Shop</h2>
        <div class="shop-section">
          <h3>Memecoins kaufen</h3>
          <button class="shop-button" onclick="buyCoin('PEPE',300)">Kaufe PEPE (300€)</button>
          <button class="shop-button" onclick="buyCoin('PEIPEI',1000)">Kaufe PEIPEI (1000€)</button>
          <button class="shop-button" onclick="buyCoin('GIGACHAD',2000)">Kaufe GIGACHAD (2000€)</button>
          <button class="shop-button" onclick="buyCoin('GAMESTOP',500)">Kaufe GAMESTOP (500€)</button>
          <p id="coin-status">Noch nicht gekaufte Coins erscheinen hier.</p>
        </div>
        <div class="shop-section">
          <h3>Autos kaufen und verkaufen</h3>
          <div id="car-list"></div>
        </div>
        <button class="back-button" onclick="showPanel('city-map')">Zurück zur Stadt</button>
      </div>
  </div>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
  // SDK-Initialisierung
  if (window.CrazyGames && window.CrazyGames.SDK) {
    window.CrazyGames.SDK.game.loadingStart();
    console.log("Loading started");
  }
  // Dein bestehender Code
  alert("Willkommen bei Deluxe Games & Investments! ...");
  // ...
  setTimeout(() => {
    if (window.CrazyGames && window.CrazyGames.SDK) {
      window.CrazyGames.SDK.game.loadingStop();
      console.log("Loading stopped");
    }
  }, 1000); // Simuliere Ladezeit von 1 Sekunde
});
    window.addEventListener('DOMContentLoaded', () => {
      alert("Willkommen bei Deluxe Games & Investments! Beachte: Alles, was du nicht in Autos, Aktien, Fonds oder Memecoins anlegst, unterliegt einer Steuer. Alle 5 Tage (25 Spielminuten) erhältst du eine Steuerrechnung über 8% deines versteuerbaren Betrags (Barvermögen abzüglich investierter Werte).");
      let balance = 100.00;
      let bankBalance = 0.00;
      let investmentValue = 0.00;
      let stocksValue = 0.00;
      let memecoins = {
        "PEPE": { unlocked: false, value: 0, price: 0.5 + Math.random()*0.5, leverage: 1, prevPrice: 0 },
        "PEIPEI": { unlocked: false, value: 0, price: 0.5 + Math.random()*0.5, leverage: 1, prevPrice: 0 },
        "GIGACHAD": { unlocked: false, value: 0, price: 0.5 + Math.random()*0.5, leverage: 1, prevPrice: 0 },
        "GAMESTOP": { unlocked: false, value: 0, price: 0.5 + Math.random()*0.5, leverage: 1, prevPrice: 0 }
      };
      let hasHouse = true;
      let credits = [];
      let invoices = [];
      let lastWorkTime = 0;
      let countdownTime = 60;
      let taxCountdownTime = 300; // 25 Minuten in Sekunden
      let expenseCountdownTime = 300; // 5 Minuten in Sekunden (1 Tag im Spiel)
      let gridSize = 5, minesCount = 10, board = [], gameOver = false, multiplier = 1.00, multiplierStep;
      let currentMinesBet = 0;
      let correctItems = 0;

      let cars = [
        { emoji: '🚗', basePrice: 56000, currentPrice: 56000, owned: 0 },
        { emoji: '🚙', basePrice: 89000, currentPrice: 89000, owned: 0 },
        { emoji: '🏎️', basePrice: 900000, currentPrice: 900000, owned: 0 }
      ];

      // Globale Variablen für die Daten aus der Spreadsheet
let globalMemecoins = [];
let globalStocksFunds = [];
let globalStocks = [];
let globalCars = [];

const supermarketTasks = [
  { item: "🥕 Karotte", correctCategory: "obst" },
  { item: "🥦 Brokkoli", correctCategory: "obst" },
  { item: "🍅 Tomate", correctCategory: "obst" },
  { item: "🥒 Gurke", correctCategory: "obst" },
  { item: "🌽 Mais", correctCategory: "obst" },
  { item: "🥬 Salat", correctCategory: "obst" },
  { item: "🧀 Käse", correctCategory: "milch" },
  { item: "🍗 Hühnchen", correctCategory: "fleisch" },
  { item: "🍟 Chips", correctCategory: "snacks" },
  { item: "🥛 Milch", correctCategory: "milch" }
];

const events = [
    { message: "Ein Investor bietet dir 500€ an!", reward: 500 }
    // Weitere Events können hier hinzugefügt werden
];

function triggerRandomEvent() {
    if (Math.random() < 0.1) { // 10% Chance pro Minute
        const event = events[Math.floor(Math.random() * events.length)];
        alert(event.message);
        localStorage.setItem('pendingEvent', JSON.stringify(event));
    }
}

setInterval(triggerRandomEvent, 60000); // Alle 60 Sekunden prüfen

setInterval(() => {
  if (window.CrazyGames && window.CrazyGames.SDK) {
    window.CrazyGames.SDK.ad.requestAd({
      type: 'midgame',
      callbacks: {
        adFinished: () => console.log("Midgame ad finished"),
        adError: () => console.log("Midgame ad error")
      }
    });
  }
}, 300000); // 5 Minuten

const goals = [
    { description: "Werde Millionär in 10 Spieltagen", target: 1000000, days: 10, achieved: false }
    // Weitere Ziele können hier hinzugefügt werden
];

function updateGoals() {
    const goalList = document.getElementById('goal-list');
    goalList.innerHTML = '';
    goals.forEach(goal => {
        const li = document.createElement('li');
        li.textContent = goal.description;
        if (goal.achieved) {
            li.style.color = 'green';
        } else if (balance + bankBalance >= goal.target) { // Einfache Prüfung ohne Tageslogik
            goal.achieved = true;
            li.style.color = 'green';
            alert(`Ziel erreicht: ${goal.description}`);
        }
        goalList.appendChild(li);
    });
}

setInterval(updateGoals, 1000); // Regelmäßig aktualisieren

function requestInviteLink() {
  if (window.CrazyGames && window.CrazyGames.SDK) {
    window.CrazyGames.SDK.user.getShareLink().then(link => {
      alert(`Lade deine Freunde ein: ${link}`);
      console.log("Invite link requested:", link);
    }).catch(err => console.log("Invite link error:", err));
  }
}

// Funktion, um Touch-Effekte zu simulieren
function addTouchEffect(element) {
  element.addEventListener('touchstart', (e) => {
    e.preventDefault();
    element.classList.add('active');
  });
  element.addEventListener('touchend', () => {
    element.classList.remove('active');
  });
}

// Wende Touch-Effekt auf alle Gebäude-Icons an
document.querySelectorAll('.building-icon').forEach(icon => {
  addTouchEffect(icon);
});

// Beispiel: Button im Shop-Panel
document.getElementById('shop-panel').innerHTML += `
  <button class="shop-button" onclick="requestInviteLink()">Freunde einladen</button>
`;

function grantFreeCasinoRound() {
    if (Math.random() < 0.05) { // 5% Chance pro Minute
        alert("Du hast eine kostenlose Spielrunde im Casino erhalten!");
        localStorage.setItem('freeCasinoRound', 'true');
    }
}

setInterval(grantFreeCasinoRound, 60000); // Alle 60 Sekunden prüfen

const fetchGlobalValues = async () => {
  try {
    const response = await fetch('https://script.google.com/macros/s/AKfycbw6kncnPNIAogY9GDIf5VVZOlrliFJXkZTqDp6E2hzRP3mAZejFkn3SBtWAwfsn5jf1Xg/exec'); // Ersetze dies mit deiner Web-App-URL
    if (!response.ok) throw new Error('Failed to fetch global values');
    const data = await response.json();
    globalMemecoins = data.memecoins || [];
    globalStocksFunds = data.stocksFunds || [];
    globalStocks = data.stocks || [];
    globalCars = data.cars || [];

    // Aktualisiere die Preise im Spiel
    updateGamePrices();
    updateMemecoinKurse();
    renderCarList();
  } catch (error) {
    console.error('Error fetching global values:', error);
  }
};

// Initialer Aufruf und dann alle 10 Sekunden aktualisieren
fetchGlobalValues();
setInterval(fetchGlobalValues, 10000);

function updateGamePrices() {
  globalMemecoins.forEach(globalCoin => {
    const coinName = globalCoin.name;
    if (memecoins[coinName]) {
      // Speichere den alten Kurs als prevPrice, bevor der neue Kurs gesetzt wird
      if (memecoins[coinName].price !== globalCoin.currentPrice) {
        memecoins[coinName].prevPrice = memecoins[coinName].price; // Vorheriger Kurs
      }
      memecoins[coinName].price = globalCoin.currentPrice;

      if (memecoins[coinName].unlocked && memecoins[coinName].value > 0) {
        // Berechne die Kursänderung nur, wenn prevPrice definiert und sinnvoll ist
        let priceChangePercent = 0;
        if (memecoins[coinName].prevPrice > 0) {
          priceChangePercent = ((globalCoin.currentPrice - memecoins[coinName].prevPrice) / memecoins[coinName].prevPrice) * 100;
        }
        const leverage = memecoins[coinName].leverage || 1;
        memecoins[coinName].value *= (1 + (priceChangePercent * leverage) / 100);

        // Verhindere negative Werte und runde auf sinnvolle Weise
        if (memecoins[coinName].value < 0) {
          alert(`${coinName} ist im Minus (${priceChangePercent.toFixed(2)}%). Automatische Auszahlung erfolgt.`);
          bankBalance += memecoins[coinName].value;
          memecoins[coinName].value = 0;
        }
      }
    }
  });

  // Aktualisiere Investmentfond
  if (globalStocksFunds.length > 0) {
    const globalFund = globalStocksFunds[0];
    // Sicherstellen, dass prevPrice und currentPrice gültige Werte haben
    const prevPrice = isNaN(globalFund.prevPrice) || globalFund.prevPrice <= 0 ? (globalFund.basePrice || 100) : globalFund.prevPrice;
    const currentPrice = isNaN(globalFund.currentPrice) || globalFund.currentPrice <= 0 ? (globalFund.basePrice || 100) : globalFund.currentPrice;

    if (investmentValue > 0) {
      const priceChangePercent = ((currentPrice - prevPrice) / prevPrice) * 100;
      const maxChangePercent = 100; // Begrenze Änderungen auf ±100%
      const limitedPriceChangePercent = Math.max(-maxChangePercent, Math.min(maxChangePercent, priceChangePercent));
      investmentValue *= (1 + (limitedPriceChangePercent / 100));
      // Verhindere Infinity oder NaN
      if (!isFinite(investmentValue) || isNaN(investmentValue)) {
        investmentValue = 0;
      }
    }
  }

  // Aktualisiere Aktien
  if (globalStocks.length > 0) {
    const globalStock = globalStocks[0];
    // Sicherstellen, dass prevPrice und currentPrice gültige Werte haben
    const prevPrice = isNaN(globalStock.prevPrice) || globalStock.prevPrice <= 0 ? (globalStock.basePrice || 100) : globalStock.prevPrice;
    const currentPrice = isNaN(globalStock.currentPrice) || globalStock.currentPrice <= 0 ? (globalStock.basePrice || 100) : globalStock.currentPrice;

    if (stocksValue > 0) {
      const priceChangePercent = ((currentPrice - prevPrice) / prevPrice) * 100;
      const maxChangePercent = 100; // Begrenze Änderungen auf ±100%
      const limitedPriceChangePercent = Math.max(-maxChangePercent, Math.min(maxChangePercent, priceChangePercent));
      stocksValue *= (1 + (limitedPriceChangePercent / 100));
      // Verhindere Infinity oder NaN
      if (!isFinite(stocksValue) || isNaN(stocksValue)) {
        stocksValue = 0;
      }
    }
  }

  // Aktualisiere Autos
  globalCars.forEach((globalCar, index) => {
    if (cars[index]) {
      cars[index].currentPrice = globalCar.currentPrice;
    }
  });

  updateHeader();
  renderMemecoinSections();
}

      const balanceElem = document.getElementById('balance-display');
      const bankDisplayElem = document.getElementById('bank-display');
      const stocksDisplayElem = document.getElementById('stocks-display');
      const investmentDisplayElem = document.getElementById('investment-display');
      const memecoinDisplayElem = document.getElementById('memecoin-display');
      const gameBoardElem = document.getElementById('game-board');
      const multiplierElem = document.getElementById('multiplier');
      const gameMessageElem = document.getElementById('game-message');
      const startGameBtn = document.getElementById('start-game');
      const takeProfitBtn = document.getElementById('take-profit');
      const workButton = document.getElementById('work-button');
      const countdownElem = document.getElementById('countdown');
      // Slot-Automat Definitionen
const slotSymbols = ['🍒', '🍋', '🍊', '🍇', '🔔', '💎'];
const slotProbabilities = [30, 25, 20, 15, 7, 3]; // Anzahl der "Stops" pro Symbol (insgesamt 100)
const slotPayouts = {
  '🍒': 12,  // 12x Einsatz für drei Kirschen
  '🍋': 18,  // 18x Einsatz für drei Zitronen
  '🍊': 25,  // 25x Einsatz für drei Orangen
  '🍇': 40,  // 40x Einsatz für drei Trauben
  '🔔': 80,  // 80x Einsatz für drei Glocken
  '💎': 150  // 150x Einsatz für drei Diamanten
};

// Erzeuge ein Array mit 100 "Stops" basierend auf den Wahrscheinlichkeiten
const reelStops = [];
slotSymbols.forEach((symbol, index) => {
  for(let i = 0; i < slotProbabilities[index]; i++) {
    reelStops.push(symbol);
  }
});

function renderCarList() {
  const carList = document.getElementById('car-list');
  carList.innerHTML = '';
  if (!Array.isArray(cars) || cars.length === 0) {
    carList.innerHTML = '<p>Keine Autos verfügbar.</p>';
    return;
  }
  cars.forEach((car, index) => {
    const carDiv = document.createElement('div');
    carDiv.innerHTML = `
      <p>${car.emoji} - Preis: €${car.currentPrice.toFixed(2)} - Besitz: ${car.owned}</p>
      <button class="shop-button" onclick="buyCar(${index})">Kaufen</button>
      <button class="shop-button" onclick="sellCar(${index})" ${car.owned === 0 ? 'disabled' : ''}>Verkaufen</button>
    `;
    carList.appendChild(carDiv);
  });
}
window.buyCar = (index) => {
  const car = cars[index];
  if (balance >= car.currentPrice) {
    balance -= car.currentPrice;
    car.owned += 1;
    updateHeader();
    renderCarList();
  } else {
    alert("Nicht genug Guthaben!");
  }
};

window.sellCar = (index) => {
  const car = cars[index];
  if (car.owned > 0) {
    balance += car.currentPrice;
    car.owned -= 1;
    updateHeader();
    renderCarList();
  } else {
    alert("Du besitzt kein Auto dieser Art!");
  }
};

// Event-Listener für den Spin-Button
document.getElementById('play-slots').addEventListener('click', () => {
  const bet = parseFloat(document.getElementById('slots-bet').value);
  if(isNaN(bet) || bet <= 0) {
    alert("Ungültiger Einsatzbetrag");
    return;
  }
  if(bet > balance) {
    alert("Nicht genug Guthaben");
    return;
  }
  balance -= bet;
  updateHeader();

  const reels = document.querySelectorAll('#slots-reels .reel');
  
  // Starte die Dreh-Animation
  const spinInterval = setInterval(() => {
    reels.forEach(reel => {
      reel.textContent = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
    });
  }, 100);

  // Stoppe nach 2 Sekunden und zeige das Endergebnis
  setTimeout(() => {
    clearInterval(spinInterval);
    const symbol1 = reelStops[Math.floor(Math.random() * 100)];
    const symbol2 = reelStops[Math.floor(Math.random() * 100)];
    const symbol3 = reelStops[Math.floor(Math.random() * 100)];
    reels[0].textContent = symbol1;
    reels[1].textContent = symbol2;
    reels[2].textContent = symbol3;

    // Überprüfe Gewinn
    if(symbol1 === symbol2 && symbol2 === symbol3) {
      const multiplier = slotPayouts[symbol1];
      const winnings = bet * multiplier;
      balance += winnings;
      updateHeader();
      document.getElementById('slots-message').textContent = `Gewinn! ${multiplier}x - €${winnings.toFixed(2)}`;
    } else {
      document.getElementById('slots-message').textContent = 'Kein Gewinn';
    }
  }, 2000);
});
      function saveGameState() {
      const gameState = {
        balance: balance,
        bankBalance: bankBalance,
        investmentValue: investmentValue,
        stocksValue: stocksValue,
        memecoins: memecoins,
        hasHouse: hasHouse,
        credits: credits,
        invoices: invoices,
        lastWorkTime: lastWorkTime,
        countdownTime: countdownTime,
        cars: cars
      };
      if (window.CrazyGames && window.CrazyGames.SDK) {
    window.CrazyGames.SDK.data.setItem('gameState', JSON.stringify(gameState));
    console.log("Data saved via CrazyGames SDK");
  }
      console.log('Saving game state:', gameState);
      localStorage.setItem('gameState', JSON.stringify(gameState));
    }

    function loadGameState() {
  const savedState = localStorage.getItem('gameState');
  if (savedState) {
    const gameState = JSON.parse(savedState);
    console.log('Game state loaded:', gameState);
    balance = gameState.balance || 100.00;
    bankBalance = gameState.bankBalance || 0.00;
    investmentValue = gameState.investmentValue || 0.00;
    stocksValue = gameState.stocksValue || 0.00;
    memecoins = gameState.memecoins || {
      "PEPE": { unlocked: false, value: 0, price: 0.5 + Math.random()*0.5, leverage: 1, prevPrice: 0 },
      "PEIPEI": { unlocked: false, value: 0, price: 0.5 + Math.random()*0.5, leverage: 1, prevPrice: 0 },
      "GIGACHAD": { unlocked: false, value: 0, price: 0.5 + Math.random()*0.5, leverage: 1, prevPrice: 0 },
      "GAMESTOP": { unlocked: false, value: 0, price: 0.5 + Math.random()*0.5, leverage: 1, prevPrice: 0 }
    };
    hasHouse = gameState.hasHouse !== undefined ? gameState.hasHouse : true;
    credits = gameState.credits || [];
    invoices = gameState.invoices || [];
    lastWorkTime = gameState.lastWorkTime || 0;
    countdownTime = gameState.countdownTime || 60;
    cars = gameState.cars || [
      { emoji: '🚗', basePrice: 56000, currentPrice: 56000, owned: 0 },
      { emoji: '🚙', basePrice: 89000, currentPrice: 89000, owned: 0 },
      { emoji: '🏎️', basePrice: 900000, currentPrice: 900000, owned: 0 }
    ];
    // Überprüfung auf ungültige Werte
    if (isNaN(investmentValue) || !isFinite(investmentValue)) investmentValue = 0.00;
    if (isNaN(stocksValue) || !isFinite(stocksValue)) stocksValue = 0.00;
    updateHeader();
    updateHouseStatus();
    renderMemecoinSections();
    updateMemecoinKurse();
  } else {
    console.log('No saved state found in localStorage.');
    cars = [
      { emoji: '🚗', basePrice: 56000, currentPrice: 56000, owned: 0 },
      { emoji: '🚙', basePrice: 89000, currentPrice: 89000, owned: 0 },
      { emoji: '🏎️', basePrice: 900000, currentPrice: 900000, owned: 0 }
    ];
    investmentValue = 0.00;
    stocksValue = 0.00;
  }
}

    loadGameState();

    function formatNumber(value) {
      if (value >= 1000000000) {
        return (value / 1000000000).toFixed(2) + "B"; // Milliarden
      } else if (value >= 1000000) {
        return (value / 1000000).toFixed(2) + "M"; // Millionen
      } else if (value >= 1000) {
        return (value / 1000).toFixed(2) + "k"; // Tausend
      } else {
        return value.toFixed(2); // Unter 1000, einfach mit 2 Dezimalstellen
      }
    }

      function updateHeader() {
        balanceElem.textContent = formatNumber(balance);
        bankDisplayElem.textContent = formatNumber(bankBalance);
        stocksDisplayElem.textContent = formatNumber(stocksValue);
        investmentDisplayElem.textContent = formatNumber(investmentValue);
        let totalMemecoins = 0;
        for(let coin in memecoins) { totalMemecoins += memecoins[coin].value; }
        memecoinDisplayElem.textContent = formatNumber(totalMemecoins);
        let totalCredit = credits.reduce((sum, cr) => sum + cr.amount, 0);
        document.getElementById('total-credit').textContent = formatNumber(totalCredit);
        updateInvoiceBar();
        updateCreditBar();
        saveGameState();
      }
      updateHeader();

      function updateMultiplier() {
        multiplierElem.textContent = multiplier.toFixed(2);
      }

      function updateInvoiceBar() {
        let totalInvoices = invoices.reduce((sum, inv) => sum + inv.amount, 0);
        document.getElementById('total-invoices').textContent = formatNumber(totalInvoices);
      }
      function updateCreditBar() {
        let totalCredits = credits.reduce((sum, cr) => sum + cr.amount, 0);
        document.getElementById('total-credits').textContent = formatNumber(totalCredits);
      }

      function updateHouseStatus() {
        const houseStatus = document.getElementById('house-status');
        if(hasHouse) {
          houseStatus.textContent = "Du besitzt dein Haus.";
          document.getElementById('stocks-section').style.display = 'block';
          document.getElementById('investment-section').style.display = 'block';
          if(Object.values(memecoins).some(c => c.unlocked)) document.getElementById('memecoin-section').style.display = 'block';
        } else {
          houseStatus.textContent = "Kein Haus! Du lebst auf der Straße. Kein Zugang zu Aktien, Fonds, Memecoins.";
          document.getElementById('stocks-section').style.display = 'none';
          document.getElementById('investment-section').style.display = 'none';
          document.getElementById('memecoin-section').style.display = 'none';
        }
      }
      updateHouseStatus();

      function renderMemecoinSections() {
        const container = document.getElementById('memecoin-container');
        container.innerHTML = '';
        for(let coin in memecoins) {
          if(memecoins[coin].unlocked) {
            let div = document.createElement('div');
            div.style.border = "1px solid #999";
            div.style.margin = "5px";
            div.style.padding = "5px";
            div.innerHTML = `
              <h4>${coin}</h4>
              <p>Wert: €<span id="memecoin-value-${coin}">${memecoins[coin].value.toFixed(2)}</span></p>
              <p>Kurs: €<span id="memecoin-price-${coin}">${memecoins[coin].price.toFixed(2)}</span></p>
              <p>Leverage: <input type="number" id="memecoin-leverage-${coin}" value="${memecoins[coin].leverage}" min="1" max="10" onchange="updateLeverage('${coin}', this.value)"></p>
              <input type="number" id="memecoin-invest-input-${coin}" value="0" min="0" placeholder="Investitionsbetrag">
              <button class="bank-button" onclick="investInCoin('${coin}')">Investieren</button>
              <button class="bank-button" onclick="withdrawCoin('${coin}')">Abheben</button>
            `;
            container.appendChild(div);
          }
        }
      }

      function updateMemecoinKurse() {
        let html = '<h3>Memecoin Kurse</h3><ul>';
        for (let coin in memecoins) {
          if (memecoins[coin].unlocked) {
            const arrowClass = memecoins[coin].prevPrice < memecoins[coin].price ? 'arrow-up' : 'arrow-down';
            const arrow = memecoins[coin].prevPrice < memecoins[coin].price ? '↑' : '↓';
            html += `<li>${coin}: €${memecoins[coin].price.toFixed(2)} <span class="${arrowClass}">${arrow}</span></li>`;
          }
        }
        html += '</ul>';
        document.getElementById('memecoin-kurse').innerHTML = html;
      }

      function updateCountdown() {
        countdownElem.textContent = `${countdownTime}s`;
        countdownTime--;
        if (countdownTime < 0) {
          countdownTime = 60;
        }
      }
      setInterval(updateCountdown, 1000);

      function updateTaxCountdown() {
        let minutes = Math.floor(taxCountdownTime / 60);
        let seconds = taxCountdownTime % 60;
        document.getElementById('tax-countdown').textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        taxCountdownTime--;
        if (taxCountdownTime < 0) {
          taxCountdownTime = 1500; // Reset auf 25 Minuten
        }
      }

      setInterval(updateTaxCountdown, 1000);

      function updateExpenseCountdown() {
  let minutes = Math.floor(expenseCountdownTime / 60);
  let seconds = expenseCountdownTime % 60;
  document.getElementById('expense-countdown').textContent = `Nächste Alltagskosten: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
  expenseCountdownTime--;
  if (expenseCountdownTime < 0) {
    expenseCountdownTime = 300; // Reset auf 5 Minuten
    applyDailyExpenses();
  }
}

setInterval(updateExpenseCountdown, 1000);

function applyDailyExpenses() {
  const dailyExpense = 30; // 30 € pro Tag
  if (balance >= dailyExpense) {
    balance -= dailyExpense;
    updateHeader();
    alert(`Alltagskosten von ${dailyExpense}€ wurden abgezogen.`);
  } else if (bankBalance >= dailyExpense) {
    bankBalance -= dailyExpense;
    updateHeader();
    alert(`Alltagskosten von ${dailyExpense}€ wurden von deinem Bankkonto abgezogen.`);
  } else {
    const creditNeeded = dailyExpense - (balance + bankBalance);
    takeCredit(creditNeeded);
    balance = 0;
    bankBalance = 0;
    updateHeader();
    alert(`Nicht genug Guthaben für die Alltagskosten von ${dailyExpense}€. Ein Notfallkredit von ${creditNeeded.toFixed(2)}€ wurde aufgenommen.`);
  }
}

      window.showPanel = (panelId) => {
        document.querySelectorAll('.panel').forEach(p => p.style.display = 'none');
        const panel = document.getElementById(panelId);
        panel.style.display = 'block';
        if (panelId === 'city-map' && window.CrazyGames && window.CrazyGames.SDK) {
          window.CrazyGames.SDK.game.gameplayStart();
          console.log("Gameplay started");
        }
        const emojiElem = document.getElementById('building-emoji');
        switch(panelId) {
          case 'house-panel':
            emojiElem.textContent = '🏠';
            break;
          case 'bank-panel':
            emojiElem.textContent = '🏦';
            break;
          case 'casino-panel':
            emojiElem.textContent = '🎰';
            break;
          case 'supermarket-panel':
            emojiElem.textContent = '🛒';
            break;
          case 'shop-panel':
            emojiElem.textContent = '🛍️';
            renderCarList();
            break;
          default:
            emojiElem.textContent = '';
        }
        if(panelId === 'casino-panel' && document.getElementById('casino-mines-tab').classList.contains('active')) {
          startMinesGame();
        }
      };

      document.getElementById('house-icon').addEventListener('click', () => { showPanel('house-panel'); });
      document.getElementById('bank-icon').addEventListener('click', () => { showPanel('bank-panel'); });
      document.getElementById('casino-icon').addEventListener('click', () => { showPanel('casino-panel'); });
      document.getElementById('shop-icon').addEventListener('click', () => { showPanel('shop-panel'); });
      document.getElementById('supermarket-icon').addEventListener('click', () => { showPanel('supermarket-panel'); });

      document.getElementById('deposit-btn').addEventListener('click', () => {
        let deposit = parseFloat(document.getElementById('bank-deposit').value);
        if(deposit > 0 && deposit <= balance) {
          balance -= deposit;
          bankBalance += deposit;
          updateHeader();
          document.getElementById('bank-deposit').value = 0;
        }
      });
      document.getElementById('withdraw-btn').addEventListener('click', () => {
        let withdraw = parseFloat(document.getElementById('bank-withdraw').value);
        if(withdraw > 0 && withdraw <= bankBalance) {
          bankBalance -= withdraw;
          balance += withdraw;
          updateHeader();
          document.getElementById('bank-withdraw').value = 0;
        }
      });
      document.getElementById('invest-btn').addEventListener('click', () => {
        if(!hasHouse) { alert("Du besitzt kein Haus – Investitionen sind nicht möglich!"); return; }
        let investAmt = parseFloat(document.getElementById('invest-amount').value);
        if(investAmt > 0 && investAmt <= balance) {
          balance -= investAmt;
          investmentValue += investAmt;
          updateHeader();
          document.getElementById('invest-amount').value = 0;
        }
      });
      document.getElementById('withdraw-investment-btn').addEventListener('click', () => {
        bankBalance += investmentValue;
        investmentValue = 0;
        updateHeader();
        document.getElementById('investment-value').textContent = investmentValue.toFixed(2);
      });
      document.getElementById('stocks-invest-btn').addEventListener('click', () => {
        if(!hasHouse) { alert("Du besitzt kein Haus – Investitionen sind nicht möglich!"); return; }
        let investAmt = parseFloat(document.getElementById('stocks-invest-amount').value);
        if(investAmt > 0 && investAmt <= balance) {
          balance -= investAmt;
          stocksValue += investAmt;
          updateHeader();
          document.getElementById('stocks-invest-amount').value = 0;
        }
      });
      document.getElementById('withdraw-stocks-btn').addEventListener('click', () => {
        bankBalance += stocksValue;
        stocksValue = 0;
        updateHeader();
        document.getElementById('stocks-value').textContent = stocksValue.toFixed(2);
      });

      document.getElementById('mailbox').addEventListener('click', () => {
        const pendingEvent = JSON.parse(localStorage.getItem('pendingEvent'));
        if (pendingEvent) {
            balance += pendingEvent.reward;
            updateHeader();
            alert(`Du hast ${pendingEvent.reward}€ erhalten!`);
            localStorage.removeItem('pendingEvent');
        } else {
            alert("Keine neuen Nachrichten.");
        }
    });

    document.getElementById('house-icon').addEventListener('touchstart', (e) => {
  e.preventDefault(); // Verhindert Scrollen
  showPanel('house-panel');
});
document.getElementById('bank-icon').addEventListener('touchstart', (e) => {
  e.preventDefault();
  showPanel('bank-panel');
});
document.getElementById('casino-icon').addEventListener('touchstart', (e) => {
  e.preventDefault();
  showPanel('casino-panel');
});
document.getElementById('shop-icon').addEventListener('touchstart', (e) => {
  e.preventDefault();
  showPanel('shop-panel');
});
document.getElementById('supermarket-icon').addEventListener('touchstart', (e) => {
  e.preventDefault();
  showPanel('supermarket-panel');
});

      window.takeCredit = (amount) => {
        let totalCredit = credits.reduce((sum, cr) => sum + cr.amount, 0);
        if(totalCredit + amount > 100000) {
          alert("Maximales Kreditlimit von 100.000€ erreicht!");
          return;
        }
        bankBalance += amount;
        credits.push({ amount: amount });
        updateHeader();
      };

      window.payAllCredits = () => {
        let totalCredits = credits.reduce((sum, cr) => sum + cr.amount, 0);
        if(bankBalance >= totalCredits) {
          bankBalance -= totalCredits;
          credits = [];
          updateHeader();
          alert("Alle Kredite wurden abbezahlt.");
        } else {
          alert("Nicht genug Guthaben, um alle Kredite abzubezahlen!");
        }
      };

      window.payAllInvoices = () => {
        let totalInvoices = invoices.reduce((sum, inv) => sum + inv.amount, 0);
        if(bankBalance >= totalInvoices) {
          bankBalance -= totalInvoices;
          invoices = [];
          updateHeader();
          alert("Alle Rechnungen wurden bezahlt.");
        } else {
          alert("Nicht genug Guthaben, um alle Rechnungen zu begleichen!");
        }
      };

      function applyCreditInterest() {
        credits.forEach((credit) => {
          let interest = credit.amount * 0.01;
          credit.amount *= 1.01;
          invoices.push({ amount: interest, timestamp: Date.now(), reminded: false });
        });
        updateHeader();
      }
      setInterval(applyCreditInterest, 300000);

      window.sellHouse = () => {
        if(!hasHouse) { alert("Du besitzt kein Haus!"); return; }
        bankBalance += 500000;
        hasHouse = false;
        updateHouseStatus();
        updateHeader();
        alert("Haus verkauft! Du lebst nun auf der Straße und verlierst den Zugang zu Investments.");
      };
      window.buyHouse = () => {
        if(hasHouse) { alert("Du besitzt bereits ein Haus!"); return; }
        if(bankBalance >= 500000) {
          bankBalance -= 500000;
          hasHouse = true;
          updateHouseStatus();
          updateHeader();
          alert("Haus zurückgekauft! Du hast wieder Zugang zu den Investments.");
        } else {
          alert("Nicht genug Guthaben, um das Haus zurückzukaufen!");
        }
      };

      window.investInCoin = (coinName) => {
  if (!hasHouse) {
    alert("Du besitzt kein Haus – Investitionen sind nicht möglich!");
    return;
  }
  let input = document.getElementById(`memecoin-invest-input-${coinName}`);
  let investAmt = parseFloat(input.value);
  if (investAmt > 0 && investAmt <= balance) {
    balance -= investAmt;
    // Initialisiere den Wert proportional zum aktuellen Kurs
    memecoins[coinName].value += investAmt;
    // Setze prevPrice auf den aktuellen Kurs zum Zeitpunkt der Investition
    memecoins[coinName].prevPrice = memecoins[coinName].price;
    input.value = 0;
    document.getElementById(`memecoin-value-${coinName}`).textContent = memecoins[coinName].value.toFixed(2);
    updateHeader();
  }
};

      window.withdrawCoin = (coinName) => {
        if(!hasHouse) { alert("Du besitzt kein Haus – Investitionen sind nicht möglich!"); return; }
        if(!memecoins[coinName].unlocked) { alert("Dieser Coin ist nicht freigeschaltet!"); return; }
        let coinValue = memecoins[coinName].value;
        if(coinValue !== 0) {
          bankBalance += coinValue;
          memecoins[coinName].value = 0;
          alert(`Automatische Auszahlung von ${coinName} erfolgt. Wert: €${coinValue.toFixed(2)}`);
          updateHeader();
          renderMemecoinSections();
        } else {
          alert("Kein Wert zum Abheben vorhanden.");
        }
      };

      window.updateLeverage = (coinName, newVal) => {
        let val = parseFloat(newVal);
        if(val < 1) { val = 1; }
        if(val > 10) { val = 10; }
        memecoins[coinName].leverage = val;
        if(val > 1) {
          alert("Warnung: Mit einem Leverage von " + val + " kann dein Investment bei einem 100%-Rückgang um bis zu " + (val * 100) + "% fallen.");
        }
      };
      window.buyCoin = (coinName, cost) => {
        if(memecoins[coinName].unlocked) {
          alert(`${coinName} ist bereits freigeschaltet!`);
          return;
        }
        if(balance >= cost) {
          balance -= cost;
          memecoins[coinName].unlocked = true;
          memecoins[coinName].price = 0.5 + Math.random()*0.5;
          memecoins[coinName].prevPrice = memecoins[coinName].price;
          alert(`${coinName} wurde freigeschaltet! Du kannst jetzt in ${coinName} investieren.`);
          document.getElementById('coin-status').textContent = "Freigeschaltete Coins: " +
            Object.keys(memecoins).filter(c => memecoins[c].unlocked).join(", ");
          document.getElementById('memecoin-section').style.display = 'block';
          renderMemecoinSections();
          updateHeader();
          updateMemecoinKurse();
        } else {
          alert("Nicht genug Guthaben!");
        }
      };

      function setupDragAndDrop() {
  const draggable = document.getElementById('draggable-food');
  const dropzones = document.querySelectorAll('.dropzone');
  const progressCounter = document.getElementById('progress-counter');

  draggable.addEventListener('dragstart', (e) => {
    draggable.classList.add('dragging');
    e.dataTransfer.setData('text/plain', draggable.dataset.category);
  });

  draggable.addEventListener('dragend', () => {
    draggable.classList.remove('dragging');
  });

  dropzones.forEach(zone => {
    zone.addEventListener('dragover', (e) => {
      e.preventDefault();
      zone.classList.add('dragover');
    });

    zone.addEventListener('dragleave', () => {
      zone.classList.remove('dragover');
    });

    zone.addEventListener('drop', (e) => {
      e.preventDefault();
      zone.classList.remove('dragover');
      const droppedCategory = e.dataTransfer.getData('text/plain');
      const correctCategory = zone.dataset.category;

      if (droppedCategory === correctCategory) {
        correctItems++;
        progressCounter.textContent = correctItems;
        document.getElementById('work-message').textContent = "Richtig eingeräumt!";
        if (correctItems >= 10) {
          bankBalance += 30;
          document.getElementById('work-message').textContent = "Super! Du hast 10 Lebensmittel korrekt eingeräumt und 30€ verdient!";
          correctItems = 0; // Zähler zurücksetzen
          progressCounter.textContent = correctItems;
          updateHeader();
        }
      } else {
        document.getElementById('work-message').textContent = "Falsches Regal!";
      }

      // Lebensmittel zurücksetzen
      draggable.style.display = 'none';
      startNewTask();
    });
  });
}

function startNewTask() {
  const task = supermarketTasks[Math.floor(Math.random() * supermarketTasks.length)];
  const draggable = document.getElementById('draggable-food');
  draggable.textContent = task.item;
  draggable.dataset.category = task.correctCategory;
  draggable.style.display = 'block';
  document.getElementById('work-message').textContent = "";
}

workButton.addEventListener('click', () => {
  startNewTask();
});

      function checkBankLetter() {
        const housePanel = document.getElementById('house-panel');
        let existingLetter = document.getElementById('bank-letter');
        if(bankBalance < 0) {
          if(!existingLetter) {
            let letter = document.createElement('div');
            letter.id = "bank-letter";
            letter.style.position = "absolute";
            letter.style.top = "10px";
            letter.style.right = "10px";
            letter.style.padding = "10px";
            letter.style.background = "#990000";
            letter.style.border = "2px solid #fff";
            letter.style.borderRadius = "5px";
            letter.style.cursor = "pointer";
            letter.textContent = `Bankbrief: Dein Konto ist im Minus: €${bankBalance.toFixed(2)}`;
            letter.title = "Klicke, um den Brief zu lesen";
            letter.addEventListener('click', () => { letter.remove(); });
            housePanel.appendChild(letter);
          }
        } else {
          if(existingLetter) { existingLetter.remove(); }
        }
      }
      setInterval(checkBankLetter, 10000);

      function checkInvoiceDue() {
    let now = Date.now();
    invoices.forEach((invoice, index) => {
        let age = now - invoice.timestamp;
        if (age >= 50000) { // 50 Millionen ms = ca. 13,89 Stunden
            if (bankBalance < invoice.amount) {
                const creditNeeded = invoice.amount - bankBalance;
                takeCredit(creditNeeded);
                alert(`Notfallkredit von ${creditNeeded.toFixed(2)}€ aufgenommen, um die Rechnung zu bezahlen.`);
                if (window.CrazyGames && window.CrazyGames.SDK) {
        window.CrazyGames.SDK.game.gameplayStop();
        console.log("Gameplay stopped");
      }
      alert("Game Over! Du konntest die Rechnungen nicht rechtzeitig begleichen.");
      location.reload();
            }
            bankBalance -= invoice.amount;
            invoices.splice(index, 1); // Rechnung bezahlen und entfernen
            updateHeader();
        } else if (age >= 48000000 && !invoice.reminded) { // Erinnerung 2 Minuten vorher
            invoice.reminded = true;
            alert("Erinnerung: Eine Rechnung muss in 2 Minuten bezahlt werden!");
        }
    });
}
      setInterval(checkInvoiceDue, 10000);

      window.showCasinoTab = (tabId) => {
        document.getElementById('casino-mines-tab').classList.remove('active');
        document.getElementById('casino-plinko-tab').classList.remove('active');
        document.getElementById('casino-roulette-tab').classList.remove('active');
        document.getElementById('mines-game').style.display = 'none';
        document.getElementById('plinko-game').style.display = 'none';
        document.getElementById('roulette-game').style.display = 'none';
        if(tabId === 'mines-game') {
          document.getElementById('casino-mines-tab').classList.add('active');
          document.getElementById('mines-game').style.display = 'block';
        } else if(tabId === 'plinko-game') {
          document.getElementById('casino-plinko-tab').classList.add('active');
          document.getElementById('plinko-game').style.display = 'block';
        } else if(tabId === 'roulette-game') {
          document.getElementById('casino-roulette-tab').classList.add('active');
          document.getElementById('roulette-game').style.display = 'block';
        } else if(tabId === 'slots-game') {
          document.getElementById('casino-slots-tab').classList.add('active');
          document.getElementById('slots-game').style.display = 'block';
        }
      };

      startGameBtn.addEventListener('click', () => {
    gridSize = parseInt(document.getElementById('grid-size').value);
    minesCount = parseInt(document.getElementById('mines-count').value);
    let bet = parseFloat(document.getElementById('mines-bet').value);
    const hasFreeRound = localStorage.getItem('freeCasinoRound') === 'true';
    if (hasFreeRound) {
        bet = 0; // Kostenlose Runde
        localStorage.removeItem('freeCasinoRound');
        alert("Kostenlose Runde wird genutzt!");
    } else if (bet > balance) {
        alert("Nicht genug Guthaben für diesen Einsatz!");
        return;
    } else {
        balance -= bet;
    }
    updateHeader();
    currentMinesBet = bet || 10; // Fallback, falls bet 0 ist
    startMinesGame();
});
      takeProfitBtn.addEventListener('click', () => {
        if(!gameOver) {
          let profit = currentMinesBet * multiplier;
          balance += profit;
          updateHeader();
          gameMessageElem.textContent = `Gewinn: €${profit.toFixed(2)}`;
          gameOver = true;
          document.querySelectorAll('.cell').forEach(cell => cell.style.pointerEvents = 'none');
        }
      });
      function startMinesGame() {
        gameOver = false;
        multiplier = 1.00;
        multiplierStep = 0.10 * (minesCount / 10);
        updateMultiplier();
        gameMessageElem.textContent = '';
        createBoard();
        placeMines();
        renderBoard();
      }
      function createBoard() {
        board = [];
        for(let i = 0; i < gridSize; i++){
          let row = [];
          for(let j = 0; j < gridSize; j++){
            row.push({ revealed: false, isMine: false, x: i, y: j });
          }
          board.push(row);
        }
      }
      function placeMines() {
        let placed = 0;
        while(placed < minesCount){
          let x = Math.floor(Math.random() * gridSize);
          let y = Math.floor(Math.random() * gridSize);
          if(!board[x][y].isMine){
            board[x][y].isMine = true;
            placed++;
          }
        }
      }
      function renderBoard() {
  gameBoardElem.innerHTML = '';
  gameBoardElem.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;
  for (let i = 0; i < gridSize; i++) {
    for (let j = 0; j < gridSize; j++) {
      const cellElem = document.createElement('div');
      cellElem.classList.add('cell');
      cellElem.dataset.x = i;
      cellElem.dataset.y = j;
      // Click-Event für Desktop
      cellElem.addEventListener('click', handleCellClick);
      // Touch-Event für Mobile
      cellElem.addEventListener('touchstart', (e) => {
        e.preventDefault();
        handleCellClick(e);
      });
      gameBoardElem.appendChild(cellElem);
    }
  }
  gameBoardElem.style.transform = 'rotateX(5deg)';
}
function handleCellClick(e) {
  if (gameOver) return;
  const x = parseInt(e.currentTarget.dataset.x);
  const y = parseInt(e.currentTarget.dataset.y);
  const cell = board[x][y];
  if (cell.revealed) return;
  cell.revealed = true;
  if (cell.isMine) {
    e.currentTarget.classList.add('mine');
    revealMines();
    gameMessageElem.textContent = 'Boom! Mine getroffen!';
    gameOver = true;
    explosionEffect(e.currentTarget);
  } else {
    e.currentTarget.classList.add('revealed');
    multiplier += multiplierStep;
    updateMultiplier();
    safeEffect(e.currentTarget);
    if (checkWin()) {
      gameMessageElem.textContent = 'Alle sicheren Felder aufgedeckt!';
      gameOver = true;
      winEffect();
    }
  }
}  
      function revealMines() {
        for(let i = 0; i < gridSize; i++){
          for(let j = 0; j < gridSize; j++){
            if(board[i][j].isMine && !board[i][j].revealed){
              const cellElem = document.querySelector(`.cell[data-x='${i}'][data-y='${j}']`);
              if(cellElem) cellElem.classList.add('mine');
            }
          }
        }
      }
      function checkWin() {
        let safe = 0;
        for(let i = 0; i < gridSize; i++){
          for(let j = 0; j < gridSize; j++){
            if(!board[i][j].isMine && board[i][j].revealed) safe++;
          }
        }
        return safe === (gridSize * gridSize - minesCount);
      }
      function explosionEffect(cellElem) {
        const rect = cellElem.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        for(let i = 0; i < 30; i++){
          const particle = document.createElement('div');
          particle.classList.add('particle');
          const dx = (Math.random()-0.5)*150;
          const dy = (Math.random()-0.5)*150;
          particle.style.position = 'fixed';
          particle.style.left = centerX + 'px';
          particle.style.top = centerY + 'px';
          particle.style.width = '5px';
          particle.style.height = '5px';
          particle.style.background = '#ff0';
          particle.style.borderRadius = '50%';
          particle.style.transform = `translate(${dx}px, ${dy}px)`;
          document.body.appendChild(particle);
          setTimeout(() => { document.body.removeChild(particle); }, 1100);
        }
      }
      function safeEffect(cellElem) {
        cellElem.style.background = 'linear-gradient(145deg, #6c6, #4a8)';
        setTimeout(() => { cellElem.style.background = ''; }, 300);
      }
      function winEffect() {
        for(let i = 0; i < 150; i++){
          const confetti = document.createElement('div');
          confetti.classList.add('particle');
          confetti.style.position = 'fixed';
          confetti.style.backgroundColor = getRandomColor();
          confetti.style.width = '8px';
          confetti.style.height = '8px';
          confetti.style.borderRadius = '0';
          confetti.style.left = Math.random() * window.innerWidth + 'px';
          confetti.style.top = '-10px';
          document.body.appendChild(confetti);
          setTimeout(() => { document.body.removeChild(confetti); }, 1100);
        }
      }
      function getRandomColor() {
        const letters = '0123456789ABCDEF';
        let color = '#';
        for(let i=0;i<6;i++){
          color += letters[Math.floor(Math.random()*16)];
        }
        return color;
      }
      function calculateTaxableAmount() {
        // Summe der investierten Werte
        let totalMemecoins = 0;
        for (let coin in memecoins) {
          totalMemecoins += memecoins[coin].value;
        }
        let totalCarsValue = cars.reduce((sum, car) => sum + car.currentPrice * car.owned, 0);
        let investedValue = totalCarsValue + stocksValue + investmentValue + totalMemecoins;

        // Versteuerbarer Betrag: Barvermögen minus investierte Werte
        let taxableAmount = balance + bankBalance - investedValue;

        // Versteuerbarer Betrag kann nicht negativ sein
        return taxableAmount > 0 ? taxableAmount : 0;
      }
      function generateTaxInvoice() {
        let taxableAmount = calculateTaxableAmount();
        let taxAmount = taxableAmount * 0.08; // 8% Steuer
        if (taxAmount > 0) {
          invoices.push({ amount: taxAmount, timestamp: Date.now(), reminded: false });
          updateInvoiceBar();
          alert(`Neue Steuerrechnung: €${taxAmount.toFixed(2)} (8% von €${taxableAmount.toFixed(2)} versteuerbarem Betrag). Begleiche sie rechtzeitig!`);
        }
      }
      setInterval(generateTaxInvoice, 300000);

      // Plinko-Spiel
      const plinkoMultipliers = [0.5, 1, 2, 5, 10, 5, 2, 1, 0.5];
      const slotCategories = {
        '0.5x': [0, 8],
        '1x': [1, 7],
        'higher': [2, 3, 4, 5, 6]
      };
      const categoryProbabilities = {
        '0.5x': 0.6,
        '1x': 0.3,
        'higher': 0.1
      };
      const plinkoCanvas = document.getElementById('plinko-canvas');
      const plinkoCtx = plinkoCanvas.getContext('2d');
      const pins = [];
      const rows = 12;
      const pinSpacing = plinkoCanvas.width / (rows + 1);

      function initPins() {
        for (let row = 0; row < rows; row++) {
          const numPins = row + 1;
          const y = (row + 1) * (plinkoCanvas.height - 50) / (rows + 1);
          for (let col = 0; col < numPins; col++) {
            const x = (plinkoCanvas.width / (numPins + 1)) * (col + 1);
            pins.push({ x, y });
          }
        }
      }

      function drawPlinkoBoard() {
        plinkoCtx.clearRect(0, 0, plinkoCanvas.width, plinkoCanvas.height);
        plinkoCtx.fillStyle = '#fff';
        pins.forEach(pin => {
          plinkoCtx.beginPath();
          plinkoCtx.arc(pin.x, pin.y, 3, 0, Math.PI * 2);
          plinkoCtx.fill();
        });
        const slotWidth = plinkoCanvas.width / plinkoMultipliers.length;
        plinkoMultipliers.forEach((multiplier, index) => {
          plinkoCtx.fillStyle = multiplier >= 5 ? '#ff4444' : multiplier >= 2 ? '#ffff44' : '#444';
          plinkoCtx.fillRect(index * slotWidth, plinkoCanvas.height - 30, slotWidth, 30);
          plinkoCtx.fillStyle = '#fff';
          plinkoCtx.font = '14px Arial';
          plinkoCtx.textAlign = 'center';
          plinkoCtx.fillText(multiplier.toFixed(1) + 'x', (index + 0.5) * slotWidth, plinkoCanvas.height - 10);
        });
      }

      function chooseCategory() {
        const rand = Math.random();
        if (rand < 0.6) return '0.5x';
        if (rand < 0.9) return '1x';
        return 'higher';
      }

      function saveGameState() {
  const gameState = {
    balance: balance,
    bankBalance: bankBalance,
    investmentValue: investmentValue,
    stocksValue: stocksValue,
    memecoins: memecoins,
    hasHouse: hasHouse,
    credits: credits,
    invoices: invoices,
    lastWorkTime: lastWorkTime,
    countdownTime: countdownTime,
    cars: cars,
    taxCountdownTime: taxCountdownTime,
    expenseCountdownTime: expenseCountdownTime
  };
  console.log('Game state saved:', gameState); // dini mueter
  localStorage.setItem('gameState', JSON.stringify(gameState));
}

function loadGameState() {
  const savedState = localStorage.getItem('gameState');
  if (savedState) {
    const gameState = JSON.parse(savedState);
    console.log('Game state loaded:', gameState); // dini mueter
    balance = gameState.balance;
    bankBalance = gameState.bankBalance;
    investmentValue = gameState.investmentValue;
    stocksValue = gameState.stocksValue;
    memecoins = gameState.memecoins;
    hasHouse = gameState.hasHouse;
    credits = gameState.credits;
    invoices = gameState.invoices;
    lastWorkTime = gameState.lastWorkTime;
    countdownTime = gameState.countdownTime;
    cars = gameState.cars || [
      { emoji: '🚗', basePrice: 56000, currentPrice: 56000, owned: 0 },
      { emoji: '🚙', basePrice: 89000, currentPrice: 89000, owned: 0 },
      { emoji: '🏎️', basePrice: 900000, currentPrice: 900000, owned: 0 }
    ];
    taxCountdownTime = gameState.taxCountdownTime || 1500;
    expenseCountdownTime = gameState.expenseCountdownTime || 300;
    updateHeader(); // Aktualisiert die Anzeige mit den geladenen Werten
    updateHouseStatus(); // Stellt den Hausstatus wieder her
    renderMemecoinSections(); // Stellt Memecoin-Informationen wieder her
    updateMemecoinKurse(); // Aktualisiert Memecoin-Kurse
  } else {
    console.log('No saved state found in localStorage.');
    cars = [
      { emoji: '🚗', basePrice: 56000, currentPrice: 56000, owned: 0 },
      { emoji: '🚙', basePrice: 89000, currentPrice: 89000, owned: 0 },
      { emoji: '🏎️', basePrice: 900000, currentPrice: 900000, owned: 0 }
    ];
  }
}

loadGameState();

let lastBonusDate = localStorage.getItem('lastBonusDate') || null;
const today = new Date().toDateString();

if (lastBonusDate !== today) {
    balance += 50;
    localStorage.setItem('lastBonusDate', today);
    updateHeader();
    alert("Du hast deinen täglichen Bonus von 50€ erhalten!");
}

      initPins();
      drawPlinkoBoard();

      document.getElementById('play-plinko').addEventListener('click', () => {
        const bet = parseFloat(document.getElementById('plinko-bet').value);
        if (isNaN(bet) || bet <= 0) {
          alert("Ungültiger Einsatzbetrag");
          return;
        }
        if (bet > balance) {
          alert("Nicht genug Guthaben");
          return;
        }
        balance -= bet;
        updateHeader();

        const category = chooseCategory();
        const slots = slotCategories[category];
        const targetSlot = slots[Math.floor(Math.random() * slots.length)];
        const slotWidth = plinkoCanvas.width / plinkoMultipliers.length;
        const targetX = (targetSlot + 0.5) * slotWidth;

        let ballX = plinkoCanvas.width / 2;
        let ballY = 0;
        const ballRadius = 8;
        let velocityX = 0;
        let velocityY = 2;
        const gravity = 0.2;

        const dropInterval = setInterval(() => {
          plinkoCtx.clearRect(0, 0, plinkoCanvas.width, plinkoCanvas.height);
          drawPlinkoBoard();

          plinkoCtx.beginPath();
          plinkoCtx.arc(ballX, ballY, ballRadius, 0, Math.PI * 2);
          plinkoCtx.fillStyle = '#ff0';
          plinkoCtx.fill();

          ballY += velocityY;
          velocityY += gravity;
          const diffX = targetX - ballX;
          velocityX += diffX * 0.015;
          if (Math.abs(velocityX) > 5) velocityX = 5 * Math.sign(velocityX);
          ballX += velocityX;

          const rowPins = pins.filter(pin => Math.abs(pin.y - ballY) < 10);
          rowPins.forEach(pin => {
            const dist = Math.sqrt((ballX - pin.x) ** 2 + (ballY - pin.y) ** 2);
            if (dist < ballRadius + 3) {
              velocityX += (Math.random() > 0.5 ? 1 : -1) * 2;
              velocityY *= 0.8;
            }
          });

          if (ballX < ballRadius) ballX = ballRadius;
          if (ballX > plinkoCanvas.width - ballRadius) ballX = plinkoCanvas.width - ballRadius;

          if (ballY >= plinkoCanvas.height - 30 - ballRadius) {
            clearInterval(dropInterval);
            const slotIndex = Math.floor(ballX / slotWidth);
            const multiplier = plinkoMultipliers[slotIndex];
            const winnings = bet * multiplier;
            balance += winnings;
            updateHeader();
            document.getElementById('plinko-message').textContent = `Die Kugel landete bei ${multiplier.toFixed(1)}x. Gewinn: €${winnings.toFixed(2)}`;
          }
        }, 20);
      });

      // Roulette-Spiel
      const rouletteNumbers = [
        { number: 0, color: 'green' }, { number: 32, color: 'red' }, { number: 15, color: 'black' },
        { number: 19, color: 'red' }, { number: 4, color: 'black' }, { number: 21, color: 'red' },
        { number: 2, color: 'black' }, { number: 25, color: 'red' }, { number: 17, color: 'black' },
        { number: 34, color: 'red' }, { number: 6, color: 'black' }, { number: 27, color: 'red' },
        { number: 13, color: 'black' }, { number: 36, color: 'red' }, { number: 11, color: 'black' },
        { number: 30, color: 'red' }, { number: 8, color: 'black' }, { number: 23, color: 'red' },
        { number: 10, color: 'black' }, { number: 5, color: 'red' }, { number: 24, color: 'black' },
        { number: 16, color: 'red' }, { number: 33, color: 'black' }, { number: 1, color: 'red' },
        { number: 20, color: 'black' }, { number: 14, color: 'red' }, { number: 31, color: 'black' },
        { number: 9, color: 'red' }, { number: 22, color: 'black' }, { number: 18, color: 'red' },
        { number: 29, color: 'black' }, { number: 7, color: 'red' }, { number: 28, color: 'black' },
        { number: 12, color: 'red' }, { number: 35, color: 'black' }, { number: 3, color: 'red' },
        { number: 26, color: 'black' }
      ];

      const rouletteCanvas = document.getElementById('roulette-canvas');
      const rouletteCtx = rouletteCanvas.getContext('2d');

      function drawRouletteWheel(rotation = 0) {
        rouletteCtx.clearRect(0, 0, rouletteCanvas.width, rouletteCanvas.height);
        const centerX = rouletteCanvas.width / 2;
        const centerY = rouletteCanvas.height / 2;
        const radius = 150;
        const angleStep = (2 * Math.PI) / rouletteNumbers.length;

        rouletteCtx.save();
        rouletteCtx.translate(centerX, centerY);
        rouletteCtx.rotate(rotation);
        rouletteCtx.translate(-centerX, -centerY);

        rouletteNumbers.forEach((num, index) => {
          const angle = index * angleStep;
          rouletteCtx.beginPath();
          rouletteCtx.moveTo(centerX, centerY);
          rouletteCtx.arc(centerX, centerY, radius, angle, angle + angleStep);
          rouletteCtx.fillStyle = num.color;
          rouletteCtx.fill();
          rouletteCtx.stroke();
          rouletteCtx.fillStyle = '#fff';
          rouletteCtx.font = '18px Arial';
          rouletteCtx.textAlign = 'center';
          const textX = centerX + (radius * 0.85) * Math.cos(angle + angleStep / 2);
          const textY = centerY + (radius * 0.85) * Math.sin(angle + angleStep / 2);
          rouletteCtx.fillText(num.number, textX, textY);
        });
        rouletteCtx.restore();
      }

      drawRouletteWheel();

      document.getElementById('play-roulette').addEventListener('click', () => {
        const bet = parseFloat(document.getElementById('roulette-bet').value);
        const wetteType = document.getElementById('roulette-wette').value;
        let wetteInput = document.getElementById('roulette-wette-input').value.trim().toLowerCase();

        if (isNaN(bet) || bet <= 0) {
          alert("Ungültiger Einsatzbetrag");
          return;
        }
        if (bet > balance) {
          alert("Nicht genug Guthaben");
          return;
        }
        if (wetteType === 'zahl') {
          wetteInput = parseInt(wetteInput);
          if (isNaN(wetteInput) || wetteInput < 0 || wetteInput > 36) {
            alert("Ungültige Zahl. Bitte wähle eine Zahl zwischen 0 und 36.");
            return;
          }
        } else if (wetteType === 'farbe') {
          if (wetteInput !== 'rot' && wetteInput !== 'schwarz') {
            alert("Ungültige Farbe. Bitte wähle 'rot' oder 'schwarz'.");
            return;
          }
          wetteInput = wetteInput === 'rot' ? 'red' : 'black';
        }

        balance -= bet;
        updateHeader();

        const resultIndex = Math.floor(Math.random() * rouletteNumbers.length);
        const result = rouletteNumbers[resultIndex];
        let rotation = 0;
        const spinDuration = 3000;
        const spinInterval = setInterval(() => {
          rotation += 0.1;
          drawRouletteWheel(rotation);
        }, 20);

        setTimeout(() => {
          clearInterval(spinInterval);
          const finalRotation = (resultIndex * (2 * Math.PI / rouletteNumbers.length)) + (Math.PI * 4);
          drawRouletteWheel(finalRotation);

          let winnings = 0;
          if (wetteType === 'zahl' && wetteInput === result.number) {
            winnings = bet * 36; // 35:1 + Einsatz
          } else if (wetteType === 'farbe' && wetteInput === result.color) {
            winnings = bet * 2; // 1:1 + Einsatz
          }
          balance += winnings;
          updateHeader();
          console.log(`Wette: ${wetteType} ${wetteInput}, Ergebnis: ${result.number} ${result.color}, Gewinn: ${winnings}`);
          document.getElementById('roulette-message').textContent = `Das Rad landete auf ${result.number} (${result.color === 'red' ? 'rot' : result.color === 'black' ? 'schwarz' : 'grün'}). Gewinn: €${winnings.toFixed(2)}`;
        }, spinDuration);
      });

      function createCar() {
  // Nur auf Geräten mit ausreichender Breite animieren
  if (window.innerWidth > 600) {
    const container = document.createElement('div');
    container.style.position = 'absolute';
    container.style.left = '0px';
    container.style.top = '210px';
    container.style.zIndex = '20';
    const car = document.createElement('div');
    car.classList.add('car');
    car.textContent = '🚗';
    car.style.transform = 'scaleX(-1)';
    container.appendChild(car);
    document.getElementById('cars-container').appendChild(container);

    car.addEventListener('click', () => {
      balance += 1;
      updateHeader();
      container.remove();
    });
    car.addEventListener('touchstart', (e) => {
      e.preventDefault();
      balance += 1;
      updateHeader();
      container.remove();
    });

    const animation = container.animate([
      { transform: 'translateX(0px)' },
      { transform: 'translateX(800px)' }
    ], {
      duration: 5000,
      iterations: 1
    });

    animation.onfinish = () => {
      container.remove();
    };
  }
}
setInterval(createCar, 10000);

function resizeCanvas() {
  const plinkoCanvas = document.getElementById('plinko-canvas');
  const rouletteCanvas = document.getElementById('roulette-canvas');
  const width = Math.min(window.innerWidth - 20, 500); // Maximal 500px
  const height = (width * 4) / 5; // Seitenverhältnis 5:4

  plinkoCanvas.width = width;
  plinkoCanvas.height = height;
  rouletteCanvas.width = width;
  rouletteCanvas.height = height;
}

// Beim Laden und bei Größenänderung anpassen
window.addEventListener('DOMContentLoaded', resizeCanvas);
window.addEventListener('resize', resizeCanvas);
      
      setupDragAndDrop();
      startNewTask();
      showPanel('city-map');
      updateHeader();
    });
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'91ed6462c855d9f1',t:'MTc0MTcyMDY0OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>